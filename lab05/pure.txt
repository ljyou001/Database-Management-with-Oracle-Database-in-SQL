CREATE TABLE STUDENTS(
NAME VARCHAR(15) NOT NULL,
STU_ID CHAR(3) NOT NULL,
BDATE DATE NOT NULL,
AGE INT,
PRIMARY KEY (STU_ID));

CREATE TABLE GRADES(
STU_ID CHAR(3) NOT NULL,
COURSE_CODE VARCHAR(8) NOT NULL,
GRADE CHAR(1),
PRIMARY KEY (STU_ID, COURSE_CODE),
FOREIGN KEY (STU_ID) REFERENCES STUDENTS (STU_ID));

CREATE TABLE GRADE_STAT(
COURSE_CODE VARCHAR(8) NOT NULL,
GRADE CHAR(1) NOT NULL,
COUNT INT,
PRIMARY KEY (COURSE_CODE, GRADE));

CREATE OR REPLACE TRIGGER questionA
BEFORE INSERT OR UPDATE ON grades
FOR EACH ROW
BEGIN
	IF (:new.grade <> 'A' AND :new.grade <> 'B' AND :new.grade <> 'C' AND :new.grade <> 'D' AND :new.grade <> 'E' AND :new.grade <> 'F') THEN
		RAISE_APPLICATION_ERROR(-20001, 'INVALID GRADE');
	END IF;
END;

INSERT INTO GRADES VALUES('123', 'COMP1150', 'G');

CREATE OR REPLACE TRIGGER questionB1
AFTER INSERT ON grades
FOR EACH ROW
DECLARE
	C INTEGER;
BEGIN
	SELECT COUNT(*) INTO C FROM GRADE_STAT
	WHERE Course_code = :new.Course_code AND Grade = :new.Grade;
	IF (C = 0)THEN
		INSERT INTO GRADE_STAT VALUES(:new.Course_code, :new.Grade, 1);
	ELSE
		UPDATE GRADE_STAT SET count=count+1
		WHERE Course_code = :new.Course_code AND Grade = :new.Grade;
	END IF;
END;

INSERT INTO STUDENTS VALUES('B','003','22-MAY-84',40);
INSERT INTO GRADES VALUES ('003', 'COMP1160', 'A');
INSERT INTO GRADES VALUES ('003', 'COMP1000', 'C');

CREATE OR REPLACE TRIGGER questionB2
AFTER DELETE ON grades
FOR EACH ROW
DECLARE
	C INTEGER;
BEGIN
	SELECT Count(*) INTO C FROM GRADE_STAT
	WHERE Course_code = :old.Course_code AND Grade = :old.Grade;
	IF (C = 1)THEN
		DELETE FROM GRADE_STAT
		WHERE Course_code = :old.Course_code AND Grade = :old.Grade;
	ELSE
		UPDATE GRADE_STAT SET count=count-1
		WHERE Course_code = :old.Course_code AND Grade = :old.Grade;
	END IF;
END;

DELETE FROM GRADES WHERE STU_ID = '002' OR STU_ID = '003';
